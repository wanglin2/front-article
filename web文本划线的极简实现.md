---
# ä¸»é¢˜åˆ—è¡¨ï¼šjuejin, github, smartblue, cyanosis, channing-cyan, fancy, hydrogen, condensed-night-purple, greenwillow, v-green, vue-pro, healer-readable, mk-cute, jzman, geek-black, awesome-green, qklhk-chocolate
# è´¡çŒ®ä¸»é¢˜ï¼šhttps://github.com/xitu/juejin-markdown-themes
theme: juejin
highlight:
---

# å¼€ç¯‡

æ–‡æœ¬åˆ’çº¿æ˜¯ç›®å‰é€æ¸æµè¡Œçš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä¸ç®¡ä½ æ˜¯å°è¯´é˜…è¯»ç½‘ç«™ï¼Œè¿˜æ˜¯å–æ•™ç¨‹çš„çš„ç½‘ç«™ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰è®°ç¬”è®°æˆ–è€…è¯„è®ºçš„åŠŸèƒ½ï¼Œä¼ ç»Ÿçš„åšæ³•éƒ½æ˜¯åœ¨æ–‡ç« åº•éƒ¨åŠ ä¸€ä¸ªè¯„è®ºåŒºï¼Œä¼˜ç‚¹æ˜¯ç®€å•ï¼Œç»Ÿä¸€ï¼Œç¼ºç‚¹æ˜¯ä¸æ–¹ä¾¿å¯¹æ–‡ç« çš„æŸä¸€æ®µæˆ–ä¸€å¥è¯è¿›è¡Œé’ˆå¯¹æ€§çš„è¯„è®ºï¼Œæ‰€ä»¥å‡ºç°äº†åˆ’çº¿åŠè¯„è®ºçš„éœ€æ±‚ï¼Œç›®å‰æˆ‘è§åˆ°çš„äº§å“æœ‰åˆ’çº¿åŠŸèƒ½çš„æœ‰ï¼šå¾®ä¿¡é˜…è¯»APPã€æå®¢æ—¶é—´ï¼š

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3221f40cf06d456a8487eeeab4cb09f0~tplv-k3u1fbpfcp-watermark.image)

InfoQå†™ä½œå¹³å°ï¼š

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63d22eb7ed4b46c7a9536b19662a3c7d~tplv-k3u1fbpfcp-watermark.image)

ç­‰ç­‰ï¼Œè¿™ä¸ªåŠŸèƒ½çœ‹ä¼¼ç®€å•ï¼Œå®é™…ä¸Šéš¾ç‚¹è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œæ¯”å¦‚å¦‚ä½•é«˜æ€§èƒ½çš„å¯¹å„ç§å¤æ‚çš„æ–‡æœ¬ç»“æ„åˆ’çº¿ã€å¦‚ä½•å°½å¯èƒ½å°‘çš„å­˜å‚¨æ•°æ®ã€å¦‚ä½•ç²¾å‡†çš„å›æ˜¾åˆ’çº¿ã€å¦‚ä½•å¤„ç†é‡å¤åˆ’çº¿ã€å¦‚ä½•åº”å¯¹æ–‡æœ¬åç»­ç¼–è¾‘çš„æƒ…å†µç­‰ç­‰ã€‚

ä½œä¸ºä¸€ä¸ªå‰ç«¯æ¬ç –å·¥ï¼Œæ¯å½“çœ‹åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„å°åŠŸèƒ½æ—¶æˆ‘éƒ½æƒ³è‡ªå·±å»æŠŠå®ƒåšå‡ºæ¥ï¼Œä½†æ˜¯çœ‹äº†ä»…æœ‰çš„å‡ ç¯‡ç›¸å…³æ–‡ç« ä¹‹åï¼Œå‘ç°ï¼Œä¸ä¼šğŸ˜“ï¼Œè¿™äº›æ–‡ç« ä»‹ç»çš„éƒ½åªæ˜¯ä¸€ä¸ªå¤§æ¦‚æ€è·¯ï¼Œçœ‹å®Œè®©äººæ„Ÿè§‰å¥½åƒä¼šäº†ï¼Œä½†æ˜¯ç»†æƒ³å°±ä¼šå‘ç°å¾ˆå¤šé—®é¢˜ï¼Œåªèƒ½å»çœ‹æºç ï¼Œçœ‹æºç æ€»æ˜¯è´¹æ—¶çš„ï¼Œè¿˜ä¸ä¸€å®šèƒ½çœ‹æ‡‚ã€‚æƒ³è¦å®ç°ä¸€ä¸ªç”Ÿäº§å¯ç”¨çš„éš¾åº¦è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œæ‰€ä»¥æœ¬æ–‡é€€è€Œæ±‚å…¶æ¬¡ï¼Œå•çº¯çš„å†™ä¸€ä¸ª`demo`å¼€å¿ƒå¼€å¿ƒã€‚`demo`æ•ˆæœè¯·ç‚¹å‡»ï¼š[http://lxqnsys.com/#/demo/textUnderline](http://lxqnsys.com/#/demo/textUnderline)ã€‚

# æ€»ä½“æ€è·¯

æ€»ä½“æ€è·¯å¾ˆç®€å•ï¼Œéå†é€‰åŒºå†…çš„æ‰€æœ‰æ–‡æœ¬ï¼Œåˆ‡å‰²æˆå•ä¸ªå­—ç¬¦ï¼Œç»™æ¯ä¸ªå­—ç¬¦éƒ½åŒ…è£¹ä¸Šåˆ’çº¿å…ƒç´ ï¼Œé‡å¤åˆ’çº¿çš„è¯å°±åœ¨æœ€æ·±å±‚ç»§ç»­åŒ…è£¹ï¼Œäº‹ä»¶å¤„ç†çš„è¯ä»æœ€æ·±çš„å…ƒç´ å¼€å§‹ã€‚

å­˜å‚¨çš„æ–¹å¼æ˜¯è®°å½•è¯¥åˆ’çº¿æ–‡æœ¬å¤–å±‚ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ çš„æ ‡ç­¾åå’Œç´¢å¼•ï¼Œä»¥åŠå­—ç¬¦åœ¨å…¶å†…æ‰€æœ‰å­—ç¬¦é‡Œæ€»çš„åç§»é‡ã€‚

å›æ˜¾çš„æ–¹å¼æ˜¯è·å–åˆ°ä¸Šè¿°å­˜å‚¨æ•°æ®å¯¹åº”çš„å…ƒç´ ï¼Œç„¶åéå†è¯¥å…ƒç´ çš„å­—ç¬¦æ·»åŠ åˆ’çº¿å…ƒç´ ã€‚

# å®ç°

## HTMLç»“æ„

```html
<div class="article" ref="article"></div>
```

æ–‡æœ¬å†…å®¹å°±æ”¾åœ¨ä¸Šè¿°çš„`div`é‡Œï¼Œæˆ‘ä»æ˜é‡‘å°å†Œé‡Œéšä¾¿æŒ‘é€‰äº†ä¸€ç¯‡æ–‡ç« ï¼ŒæŠŠå®ƒçš„`html`ç»“æ„åŸå°ä¸åŠ¨çš„å¤åˆ¶ç²˜è´´è¿›å»ï¼š

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f289f332523b483cb2b23aa74bcaa043~tplv-k3u1fbpfcp-watermark.image)


## æ˜¾ç¤ºtooltip

é¦–å…ˆè¦åšçš„æ˜¯åœ¨é€‰åŒºä¸Šæ˜¾ç¤ºä¸€ä¸ªåˆ’çº¿æŒ‰é’®ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œæˆ‘ä»¬ç›‘å¬ä¸€ä¸‹`mouseup`äº‹ä»¶ï¼Œç„¶åè·å–ä¸€ä¸‹é€‰åŒºå¯¹è±¡ï¼Œè°ƒç”¨å®ƒçš„`getBoundingClientRect`æ–¹æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œç„¶åè®¾ç½®åˆ°æˆ‘ä»¬çš„`tooltip`å…ƒç´ ä¸Šï¼š

```js
document.addEventListener('mouseup', this.onMouseup)

onMouseup () {
    // è·å–Selectionå¯¹è±¡ï¼Œé‡Œé¢å¯èƒ½åŒ…å«å¤šä¸ª`ranges`ï¼ˆåŒºåŸŸï¼‰
    let selObj = window.getSelection()
    // ä¸€èˆ¬å°±åªæœ‰ä¸€ä¸ªRangeå¯¹è±¡
    let range = selObj.getRangeAt(0)
    // å¦‚æœé€‰åŒºèµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ç›¸åŒï¼Œé‚£ä»£è¡¨æ²¡æœ‰é€‰åˆ°ä»»ä½•ä¸œè¥¿
    if (range.collapsed) {
        return
    }
    this.range = range.cloneRange()
    this.tipText = 'åˆ’çº¿'
    this.setTip(range)
}

setTip (range) {
    let { left, top, width } = range.getBoundingClientRect()
    this.tipLeft = left + (width - 80) / 2
    this.tipTop = top - 40
    this.showTip = true
}
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47cdf3dae38641d090489297ca5378f8~tplv-k3u1fbpfcp-watermark.image)


## åˆ’çº¿

ç»™`tooltip`ç»‘å®šä¸€ä¸‹ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»åéœ€è¦è·å–åˆ°é€‰åŒºå†…çš„æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œå…ˆçœ‹ä¸€ä¸‹`Range`å¯¹è±¡çš„ç»“æ„ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d8afb4a0a5f4b33905962b652c5fd02~tplv-k3u1fbpfcp-watermark.image)

ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š

`collapsed`å±æ€§è¡¨ç¤ºå¼€å§‹å’Œç»“æŸçš„ä½ç½®æ˜¯å¦ç›¸åŒï¼›

`commonAncestorContainer`å±æ€§è¿”å›åŒ…å«`startContainer`å’Œ`endContainer`çš„å…¬å…±çˆ¶èŠ‚ç‚¹ï¼›

`endContainer`å±æ€§è¿”å›åŒ…å«`range`ç»ˆç‚¹çš„èŠ‚ç‚¹ï¼Œé€šå¸¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼›

`endOffset`è¿”å›`range`ç»ˆç‚¹åœ¨`endContainer`å†…çš„ä½ç½®çš„æ•°å­—ï¼›

`startContainer`å±æ€§è¿”å›åŒ…å«`range`èµ·ç‚¹çš„èŠ‚ç‚¹ï¼Œé€šå¸¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼›

`startContainer`è¿”å›`range`èµ·ç‚¹åœ¨`startContainer`å†…çš„ä½ç½®çš„æ•°å­—ï¼›

æ‰€ä»¥ç›®æ ‡æ˜¯è¦éå†`startContainer`å’Œ`endContainer`ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æ‰€æœ‰èŠ‚ç‚¹æ¥æ”¶é›†æ–‡æœ¬èŠ‚ç‚¹ï¼Œå—é™äºç¬”è€…åŒ®ä¹çš„ç®—æ³•å’Œæ•°æ®ç»“æ„çŸ¥è¯†ï¼Œåªèƒ½é€‰æ‹©ä¸€ä¸ªæŠ•æœºå–å·§çš„æ–¹æ³•ï¼Œéå†`commonAncestorContainer`èŠ‚ç‚¹ï¼Œç„¶åä½¿ç”¨`range`å¯¹è±¡çš„`isPointInRange()`æ–¹æ³•æ¥æ£€æµ‹å½“å‰éå†çš„èŠ‚ç‚¹æ˜¯å¦åœ¨é€‰åŒºèŒƒå›´å†…ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦æ³¨æ„çš„ä¸¤ä¸ªç‚¹åœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯`isPointInRange()`æ–¹æ³•ç›®å‰ä¸æ”¯æŒ`IE`ï¼ŒäºŒæ˜¯é¦–å°¾èŠ‚ç‚¹éœ€è¦å•ç‹¬å¤„ç†ï¼Œå› ä¸ºé¦–å°¾èŠ‚ç‚¹å¯èƒ½éƒ¨åˆ†åœ¨é€‰åŒºå†…ï¼Œè¿™æ ·è¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›`false`çš„ã€‚

```js
mark () 
  this.textNodes = []
  let { commonAncestorContainer, startContainer, endContainer } = this.range
  this.walk(commonAncestorContainer, (node) => {
    if (
      node === startContainer ||
      node === endContainer ||
      this.range.isPointInRange(node, 0)
    ) {// èµ·å§‹å’Œç»“æŸèŠ‚ç‚¹ï¼Œæˆ–è€…åœ¨èŒƒå›´å†…çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹åˆ™æ”¶é›†èµ·æ¥
      if (node.nodeType === 3) {
        this.textNodes.push(node)
      }
    }
  })
  this.handleTextNodes()
  this.showTip = false
  this.tipText = ''
}
```

`walk`æ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆéå†çš„å‡½æ•°ï¼š

```js
walk (node, callback = () => {}) {
    callback(node)
    if (node && node.childNodes) {
        for (let i = 0; i < node.childNodes.length; i++) {
            this.walk(node.childNodes[i], callback)
        }
    }
}
```

è·å–åˆ°é€‰åŒºèŒƒå›´å†…çš„æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹åå°±å¯ä»¥åˆ‡å‰²å­—ç¬¦è¿›è¡Œå…ƒç´ æ›¿æ¢ï¼š

```js
handleTextNodes () {
    // ç”Ÿæˆæœ¬æ¬¡çš„å”¯ä¸€id
    let id = ++this.idx
    // éå†æ–‡æœ¬èŠ‚ç‚¹
    this.textNodes.forEach((node) => {
        // èŒƒå›´çš„é¦–å°¾å…ƒç´ éœ€è¦åˆ¤æ–­ä¸€ä¸‹åç§»é‡ï¼Œç”¨æ¥æˆªå–å­—ç¬¦
        let startOffset = 0
        let endOffset = node.nodeValue.length
        if (
            node === this.range.startContainer &&
            this.range.startOffset !== 0
        ) {
            startOffset = this.range.startOffset
        }
        if (node === this.range.endContainer && this.range.endOffset !== 0) {
            endOffset = this.range.endOffset
        }
        // æ›¿æ¢è¯¥æ–‡æœ¬èŠ‚ç‚¹
        this.replaceTextNode(node, id, startOffset, endOffset)
    })
    // åºåˆ—åŒ–è¿›è¡Œå­˜å‚¨ï¼Œè·å–åˆšåˆšç”Ÿæˆçš„æ‰€æœ‰è¯¥idçš„åˆ’çº¿å…ƒç´ 
    this.serialize(this.$refs.article.querySelectorAll('.mark_id_' + id))
}
```

å¦‚æœæ˜¯é¦–èŠ‚ç‚¹ï¼Œä¸”`startOffset`ä¸ä¸º0ï¼Œé‚£ä¹ˆ`startOffset`ä¹‹å‰çš„å­—ç¬¦ä¸éœ€è¦æ·»åŠ åˆ’çº¿åŒ…è£¹å…ƒç´ ï¼Œå¦‚æœæ˜¯å°¾èŠ‚ç‚¹ï¼Œä¸”`endOffset`ä¸ä¸º0ï¼Œé‚£ä¹ˆ`endOffset`ä¹‹åçš„å­—ç¬¦ä¸éœ€è¦åˆ’çº¿ï¼Œä¸­é—´çš„å…¶ä»–æ‰€æœ‰æ–‡æœ¬éƒ½éœ€è¦è¿›è¡Œåˆ‡å‰²åŠåˆ’çº¿ï¼š

```js
replaceTextNode (node, id, startOffset, endOffset) {
    // åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µç”¨æ¥æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
    let fragment = document.createDocumentFragment()
    let startNode = null
    let endNode = null
    // æˆªå–å‰ä¸€æ®µä¸éœ€è¦åˆ’çº¿çš„æ–‡æœ¬
    if (startOffset !== 0) {
        startNode = document.createTextNode(
            node.nodeValue.slice(0, startOffset)
        )
    }
    // æˆªå–åä¸€æ®µä¸éœ€è¦åˆ’çº¿çš„æ–‡æœ¬
    if (endOffset !== 0) {
        endNode = document.createTextNode(node.nodeValue.slice(endOffset))
    }
    startNode && fragment.appendChild(startNode)
    // åˆ‡å‰²ä¸­é—´çš„æ‰€æœ‰æ–‡æœ¬
    node.nodeValue
        .slice(startOffset, endOffset)
        .split('')
        .forEach((text) => {
        // åˆ›å»ºä¸€ä¸ªspanæ ‡ç­¾ç”¨æ¥ä½œä¸ºåˆ’çº¿åŒ…è£¹å…ƒç´ 
        let textNode = document.createElement('span')
        textNode.className = 'markLine mark_id_' + id
        textNode.setAttribute('data-id', id)
        textNode.textContent = text
        fragment.appendChild(textNode)
    })
    endNode && fragment.appendChild(endNode)
    // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
    node.parentNode.replaceChild(fragment, node)
}
```

æ•ˆæœå¦‚ä¸‹ï¼š

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17149bd2b47946a4b9c6a2147fb3b677~tplv-k3u1fbpfcp-watermark.image)

æ­¤æ—¶`html`ç»“æ„ï¼š

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7e450a33eb214733b72e149924ebaeb5~tplv-k3u1fbpfcp-watermark.image)


## åºåˆ—åŒ–å­˜å‚¨

ä¸€æ¬¡æ€§çš„åˆ’çº¿æ˜¯æ²¡å•¥ç”¨çš„ï¼Œé‚£è¿˜ä¸å¦‚åœ¨æ–‡ç« ä¸Šé¢ç›–ä¸€ä¸ª`canvas`å…ƒç´ ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªè‡ªç”±ç”»å¸ƒï¼Œæ‰€ä»¥è¿˜éœ€è¦è¿›è¡Œä¿å­˜ï¼Œä¸‹æ¬¡æ‰“å¼€è¿˜èƒ½é‡æ–°æ˜¾ç¤ºä¹‹å‰ç”»çš„çº¿ã€‚

å­˜å‚¨çš„å…³é”®æ˜¯è¦èƒ½è®©ä¸‹æ¬¡è¿˜èƒ½å®šä½å›å»ï¼Œå‚è€ƒå…¶ä»–æ–‡ç« ä»‹ç»çš„æ–¹æ³•ï¼Œæœ¬æ–‡é€‰æ‹©çš„æ˜¯å­˜å‚¨åˆ’çº¿å…ƒç´ å¤–å±‚çš„ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ çš„æ ‡ç­¾åï¼Œä»¥åŠåœ¨æŒ‡å®šèŠ‚ç‚¹èŒƒå›´å†…çš„åŒç±»å‹å…ƒç´ é‡Œçš„ç´¢å¼•ï¼Œä»¥åŠè¯¥å­—ç¬¦åœ¨è¯¥éåˆ’çº¿å…ƒç´ é‡Œçš„æ€»çš„å­—ç¬¦åç§»é‡ã€‚æè¿°èµ·æ¥å¯èƒ½æœ‰ç‚¹ç»•ï¼Œçœ‹ä»£ç ï¼š

```js
serialize (markNodes) {
    // é€‰æ‹©articleå…ƒç´ ä½œä¸ºæ ¹å…ƒç´ ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯é¡µé¢çš„å…¶ä»–ç»“æ„å¦‚æœæ”¹å˜äº†ä¸å½±å“åˆ’çº¿å…ƒç´ çš„å®šä½
    let root = this.$refs.article
    // éå†åˆšåˆšç”Ÿæˆçš„æœ¬æ¬¡åˆ’çº¿çš„æ‰€æœ‰spanèŠ‚ç‚¹
    markNodes.forEach((markNode) => {
        // è®¡ç®—è¯¥å­—ç¬¦ç¦»å¤–å±‚ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ çš„æ€»çš„æ–‡æœ¬åç§»é‡
        let offset = this.getTextOffset(markNode)
        // æ‰¾åˆ°å¤–å±‚ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ 
        let { tagName, index } = this.getWrapNode(markNode, root)
        // ä¿å­˜ç›¸å…³æ•°æ®
        this.serializeData.push({
          tagName,
          index,
          offset,
          id: markNode.getAttribute('data-id')
        })
    })
}
```

è®¡ç®—å­—ç¬¦ç¦»å¤–å±‚ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ çš„æ€»çš„æ–‡æœ¬åç§»é‡çš„æ€è·¯æ˜¯å…ˆç®—è·å–åŒçº§ä¸‹ä¹‹å‰çš„å…„å¼Ÿå…ƒç´ çš„æ€»å­—ç¬¦æ•°ï¼Œå†ä¾æ¬¡å‘ä¸Šéå†çˆ¶å…ƒç´ åŠå…¶ä¹‹å‰çš„å…„å¼ŸèŠ‚ç‚¹çš„æ€»å­—ç¬¦æ•°ï¼Œç›´åˆ°å¤–å±‚å…ƒç´ ï¼š

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2916447562304033bd67666fccf7bcc1~tplv-k3u1fbpfcp-watermark.image)

```js
getTextOffset (node) {
    let offset = 0
    let parNode = node
    // éå†ç›´åˆ°å¤–å±‚ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ 
    while (parNode && parNode.classList.contains('markLine')) {
        // è·å–å‰é¢çš„å…„å¼Ÿå…ƒç´ çš„æ€»å­—ç¬¦æ•°
        offset += this.getPrevSiblingOffset(parNode)
        parNode = parNode.parentNode
    }
    return offset
}
```

è·å–å‰é¢çš„å…„å¼Ÿå…ƒç´ çš„æ€»å­—ç¬¦æ•°ï¼š

```js
getPrevSiblingOffset (node) {
    let offset = 0
    let prevNode = node.previousSibling
    while (prevNode) {
        offset +=
            prevNode.nodeType === 3
            ? prevNode.nodeValue.length
        : prevNode.textContent.length
        prevNode = prevNode.previousSibling
    }
    return offset
}
```

è·å–å¤–å±‚ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ åœ¨ä¸Šé¢è·å–å­—ç¬¦æ•°çš„æ–¹æ³•é‡Œå…¶å®å·²ç»æœ‰äº†ï¼š

```js
getWrapNode (node, root) {
  	// æ‰¾åˆ°å¤–å±‚ç¬¬ä¸€ä¸ªéåˆ’çº¿å…ƒç´ 
    let wrapNode = node.parentNode
    while (wrapNode.classList.contains('markLine')) {
        wrapNode = wrapNode.parentNode
    }
    let wrapNodeTagName = wrapNode.tagName
    // è®¡ç®—ç´¢å¼•
    let wrapNodeIndex = -1
    // ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨è·å–æ‰€æœ‰è¯¥æ ‡ç­¾å…ƒç´ 
    let els = root.getElementsByTagName(wrapNodeTagName)
    els = [...els].filter((item) => {// è¿‡æ»¤æ‰åˆ’çº¿å…ƒç´ 
      return !item.classList.contains('markLine');
    }).forEach((item, index) => {// è®¡ç®—å½“å‰å…ƒç´ åœ¨å…¶ä¸­çš„ç´¢å¼•
      if (wrapNode === item) {
        wrapNodeIndex = index
      }
    })
    return {
        tagName: wrapNodeTagName,
        index: wrapNodeIndex
    }
}
```

æœ€åå­˜å‚¨çš„æ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d304df41d1940079d0d31fae4b995d4~tplv-k3u1fbpfcp-watermark.image)


## ååºåˆ—åŒ–æ˜¾ç¤º

æ˜¾ç¤ºå°±æ˜¯æ ¹æ®ä¸Šé¢å­˜å‚¨çš„æ•°æ®æŠŠçº¿ç”»ä¸Šï¼Œéå†ä¸Šé¢çš„æ•°æ®ï¼Œå…ˆæ ¹æ®`tagName`å’Œ`index`è·å–åˆ°æŒ‡å®šå…ƒç´ ï¼Œç„¶åéå†è¯¥å…ƒç´ ä¸‹çš„æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ ¹æ®`offset`æ‰¾åˆ°éœ€è¦åˆ’çº¿çš„å­—ç¬¦ï¼š

```js
deserialization () {
    let root = this.$refs.article
    // éå†åºåˆ—åŒ–çš„æ•°æ®
    markData.forEach((item) => {
        // è·å–åˆ°æŒ‡å®šå…ƒç´ 
        let els = root.getElementsByTagName(item.tagName)
        els = [...els].filter((item) => {// è¿‡æ»¤æ‰åˆ’çº¿å…ƒç´ 
          return !item.classList.contains('markLine');
        })
        let wrapNode = els[item.index]
        let len = 0
        let end = false
        // éå†è¯¥å…ƒç´ æ‰€æœ‰èŠ‚ç‚¹
        this.walk(wrapNode, (node) => {
            if (end) {
                return
            }
            // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹
            if (node.nodeType === 3) {
                // å¦‚æœå½“å‰æ–‡æœ¬èŠ‚ç‚¹çš„å­—ç¬¦æ•°+ä¹‹å‰çš„æ€»æ•°å¤§äºoffsetï¼Œè¯´æ˜è¦æ‰¾çš„å­—ç¬¦å°±åœ¨è¯¥æ–‡æœ¬å†…
                if (len + node.nodeValue.length > item.offset) {
                    // è®¡ç®—åœ¨è¯¥æ–‡æœ¬é‡Œçš„åç§»é‡
                    let startOffset = item.offset - len
                    // å› ä¸ºæˆ‘ä»¬æ˜¯åˆ‡å‰²åˆ°å•ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥æ€»é•¿åº¦ä¹Ÿå°±æ˜¯1
                    let endOffset = startOffset + 1
                    this.replaceTextNode(node, item.id, startOffset, endOffset)
                    end = true
                }
                // ç´¯åŠ å­—ç¬¦æ•°
                len += node.nodeValue.length
            }
        })
    })
}
```

ç»“æœå¦‚ä¸‹ï¼š

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f584a39b05c94317b01678f8eee004b3~tplv-k3u1fbpfcp-watermark.image)


## åˆ é™¤åˆ’çº¿

åˆ é™¤åˆ’çº¿å¾ˆç®€å•ï¼Œæˆ‘ä»¬ç›‘å¬ä¸€ä¸‹ç‚¹å‡»äº‹ä»¶ï¼Œå¦‚æœç›®æ ‡å…ƒç´ æ˜¯åˆ’çº¿å…ƒç´ ï¼Œé‚£ä¹ˆè·å–ä¸€ä¸‹æ‰€æœ‰è¯¥`id`çš„åˆ’çº¿å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª`range`ï¼Œæ˜¾ç¤ºä¸€ä¸‹`tooltip`ï¼Œç„¶åç‚¹å‡»åæŠŠè¯¥åˆ’çº¿å…ƒç´ åˆ é™¤å³å¯ã€‚

```js
// æ˜¾ç¤ºå–æ¶ˆåˆ’çº¿çš„tooltip
showCancelTip (e) {
    let tar = e.target
    if (tar.classList.contains('markLine')) {
        e.stopPropagation()
        e.preventDefault()
        // è·å–åˆ’çº¿id
        this.clickId = tar.getAttribute('data-id')
        // è·å–è¯¥idçš„æ‰€æœ‰åˆ’çº¿å…ƒç´ 
        let markNodes = document.querySelectorAll('.mark_id_' + this.clickId)
        // é€‰æ‹©ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹æ¥ä½œä¸ºrangeè¾¹ç•Œ
        let startContainer = markNodes[0].firstChild
        let endContainer = markNodes[markNodes.length - 1].lastChild
        this.range = document.createRange()
        this.range.setStart(startContainer, 0)
        this.range.setEnd(
          endContainer,
          endContainer.nodeValue.length
        )
        this.tipText = 'å–æ¶ˆåˆ’çº¿'
        this.setTip(this.range)
    }
}
```

ç‚¹å‡»äº†å–æ¶ˆæŒ‰é’®åéå†è¯¥`id`çš„æ‰€æœ‰åˆ’çº¿èŠ‚ç‚¹ï¼Œè¿›è¡Œå…ƒç´ æ›¿æ¢ï¼š

```js
cancelMark () {
    this.showTip = false
    this.tipText = ''
    let markNodes = document.querySelectorAll('.mark_id_' + this.clickId)
    // éå†æ‰€æœ‰åˆ’çº¿è¡—é“
    for (let i = 0; i < markNodes.length; i++) {
        let item = markNodes[i]
        // å¦‚æœè¿˜æœ‰å­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å…¶ä»–idçš„åˆ’çº¿å…ƒç´ 
        if (item.children[0]) {
            let node = item.children[0].cloneNode(true)
            // å­èŠ‚ç‚¹æ›¿æ¢å½“å‰èŠ‚ç‚¹
            item.parentNode.replaceChild(node, item)
        } else {// å¦åˆ™åªæœ‰æ–‡æœ¬çš„è¯ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹æ¥æ›¿æ¢
            let textNode = document.createTextNode(item.textContent)
            item.parentNode.replaceChild(textNode, item)
        }
    }
    // ä»åºåˆ—åŒ–æ•°æ®é‡Œåˆ é™¤è¯¥idçš„æ•°æ®
    this.serializeData = this.serializeData.filter((item) => {
        return item.id !== this.clickId
    })
}
```

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cdb0a1d4daca456dae3928a92a0e3a25~tplv-k3u1fbpfcp-watermark.image)


## ç¼ºç‚¹

åˆ°è¿™é‡Œè¿™ä¸ªæç®€åˆ’çº¿å°±ç»“æŸäº†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæç®€çš„æ–¹æ³•æœ‰ä»€ä¹ˆç¼ºç‚¹.

é¦–å…ˆæ¯‹åº¸ç½®ç–‘çš„å°±æ˜¯å¦‚æœåˆ’çº¿å­—ç¬¦å¾ˆå¤šï¼Œé‡å¤åˆ’çº¿å¾ˆå¤šæ¬¡ï¼Œé‚£ä¹ˆä¼šç”Ÿæˆéå¸¸å¤šçš„`span`æ ‡ç­¾åŠåµŒå¥—å±‚æ¬¡ï¼ŒèŠ‚ç‚¹æ•°é‡æ˜¯å½±å“é¡µé¢æ€§èƒ½çš„ä¸€ä¸ªå¤§é—®é¢˜ã€‚

ç¬¬äºŒä¸ªé—®é¢˜æ˜¯éœ€è¦å­˜å‚¨çš„æ•°æ®ä¹Ÿä¼šå¾ˆå¤§ï¼Œå¢åŠ å­˜å‚¨æˆæœ¬å’Œç½‘ç»œä¼ è¾“æ—¶é—´ï¼š

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c575386f4b614205bcd694f353eac6be~tplv-k3u1fbpfcp-watermark.image)

è¿™å¯ä»¥é€šè¿‡æŠŠå­—æ®µåå­—å‹ç¼©ä¸€ä¸‹ï¼Œæ”¹æˆä¸€ä¸ªå­—æ¯ï¼Œå¦å¤–å¯ä»¥æŠŠè¿ç»­çš„å­—ç¬¦åˆå¹¶ä¸€ä¸‹æ¥ç¨å¾®ä¼˜åŒ–ä¸€ä¸‹ï¼Œä½†æ˜¯ç„¶å¹¶åµã€‚

ç¬¬ä¸‰ä¸ªé—®é¢˜æ˜¯å¦‚å…¶åï¼Œæ–‡æœ¬åˆ’çº¿ï¼ŒçœŸçš„æ˜¯åªèƒ½ç»™æ–‡æœ¬è¿›è¡Œåˆ’çº¿ï¼Œå…¶ä»–çš„å›¾ç‰‡ä¸Šé¢çš„å°±ä¸è¡Œäº†ï¼š

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1104c5b6921a45c7aab1678410e0816e~tplv-k3u1fbpfcp-watermark.image)

ç¬¬å››ä¸ªé—®é¢˜æ˜¯æ— æ³•åº”å¯¹å¦‚æœåˆ’çº¿åæ–‡ç« è¢«ä¿®æ”¹äº†ï¼Œ`html`ç»“æ„å˜åŒ–äº†çš„é—®é¢˜ã€‚

è¿™å‡ ä¸ªé—®é¢˜ä¸ªä¸ªæ‰å¿ƒï¼Œå¯¼è‡´å®ƒåªèƒ½æ˜¯ä¸ª`demo`ã€‚

## ç¨å¾®ä¼˜åŒ–ä¸€ä¸‹

å¾ˆå®¹æ˜“æƒ³åˆ°çš„ä¸€ä¸ªä¼˜åŒ–æ–¹æ³•æ˜¯ä¸è¦æŠŠå­—ç¬¦å•ä¸ªåˆ‡å‰²ï¼Œæ•´å—åŒ…è£¹ä¸å°±å¥½äº†å—ï¼Œé“ç†æ˜¯è¿™ä¸ªé“ç†ï¼š

```js
replaceTextNode (node, id, startOffset, endOffset) {
    // ...
    startNode && fragment.appendChild(startNode)

    // æ”¹æˆç›´æ¥åŒ…è£¹æ•´å—æ–‡æœ¬
    let textNode = document.createElement('span')
    textNode.className = 'markLine mark_id_' + id
    textNode.setAttribute('data-id', id)
    textNode.textContent = node.nodeValue.slice(startOffset, endOffset)
    fragment.appendChild(textNode)
    
    endNode && fragment.appendChild(endNode)
    // ...
}
```

è¿™æ ·åºåˆ—åŒ–æ—¶éœ€è¦å¢åŠ ä¸€ä¸ªé•¿åº¦çš„å­—æ®µï¼š

```js
let textLength = markNode.textContent.length
if (textLength > 0) {// è¿‡æ»¤æ‰é•¿åº¦ä¸º0çš„ç©ºå­—ç¬¦ï¼Œå¦åˆ™ä¼šæœ‰ä¸å¯é¢„çŸ¥çš„é—®é¢˜
	this.serializeData.push({
      tagName,
      index,
      offset,
      length: textLength,// ++
      id: markNode.getAttribute('data-id')
  })
}
```

è¿™æ ·åºåˆ—åŒ–åçš„æ•°æ®é‡ä¼šå¤§å¤§å‡å°‘ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b83dbb5e5864bb8a456cc553a0a5fcc~tplv-k3u1fbpfcp-watermark.image)

æ¥ä¸‹æ¥ååºåˆ—åŒ–ä¹Ÿéœ€è¦ä¿®æ”¹ï¼Œå­—ç¬¦é•¿åº¦ä¸å®šçš„è¯å°±å¯èƒ½è·¨æ–‡æœ¬èŠ‚ç‚¹äº†ï¼š

```js
deserialization () {
    let root = this.$refs.article
    markData.forEach((item) => {
        let wrapNode = root.getElementsByTagName(item.tagName)[item.index]
        let len = 0
        let end = false
        let first = true
        let _length = item.length
        this.walk(wrapNode, (node) => {
            if (end) {
                return
            }
            if (node.nodeType === 3) {
                let nodeTextLength = node.nodeValue.length
                if (len + nodeTextLength > _offset) {
                    // startOffsetä¹‹å‰çš„æ–‡æœ¬ä¸éœ€è¦åˆ’çº¿
                    let startOffset = (first ? item.offset - len : 0)
                    first = false
                    // å¦‚æœè¯¥æ–‡æœ¬èŠ‚ç‚¹å‰©ä½™çš„å­—ç¬¦æ•°é‡å°äºåˆ’çº¿æ–‡æœ¬çš„å­—ç¬¦é•¿åº¦çš„è¯ä»£è¡¨è¯¥æ–‡æœ¬èŠ‚ç‚¹è¿˜åªæ˜¯åˆ’çº¿æ–‡æœ¬çš„ä¸€éƒ¨åˆ†ï¼Œè¿˜éœ€è¦åˆ°ä¸‹ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹é‡Œå»å¤„ç†
                    let endOffset = startOffset + (nodeTextLength - startOffset >= _length ? _length : nodeTextLength - startOffset)
                    this.replaceTextNode(node, item.id, startOffset, endOffset)
                    // é•¿åº¦éœ€è¦å‡å»ä¹‹å‰èŠ‚ç‚¹å·²ç»å¤„ç†æ‰çš„é•¿åº¦
                    _length = _length - (nodeTextLength - startOffset)
                    // å¦‚æœå‰©ä½™è¦å¤„ç†çš„åˆ’çº¿æ–‡æœ¬çš„å­—ç¬¦æ•°é‡ä¸º0ä»£è¡¨å·²ç»å¤„ç†å®Œäº†ï¼Œå¯ä»¥ç»“æŸäº†
                    if (_length <= 0) {
                      end = true
                    }
                  }
                len += nodeTextLength
            }
        })
    })
}
```

æœ€åå–æ¶ˆåˆ’çº¿ä¹Ÿéœ€è¦ä¿®æ”¹ï¼Œå› ä¸ºå­èŠ‚ç‚¹å¯èƒ½å°±ä¸æ˜¯åªæœ‰å•çº¯çš„ä¸€ä¸ªåˆ’çº¿èŠ‚ç‚¹æˆ–æ–‡æœ¬èŠ‚ç‚¹äº†ï¼Œéœ€è¦éå†å…¨éƒ¨å­èŠ‚ç‚¹ï¼š

```js
cancelMark () {
    this.showTip = false
    this.tipText = ''
    let markNodes = document.querySelectorAll('.mark_id_' + this.clickId)
    for (let i = 0; i < markNodes.length; i++) {
        let item = markNodes[i]
        let fregment = document.createDocumentFragment()
        for (let j = 0; j < item.childNodes.length; j++) {
            fregment.appendChild(item.childNodes[j].cloneNode(true))
        }
        item.parentNode.replaceChild(fregment, item)
    }
    this.serializeData = this.serializeData.filter((item) => {
        return item.id !== this.clickId
    })
}
```

ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹æ•ˆæœï¼š

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/159ce99ea71746a2ae13bd5dfd29a474~tplv-k3u1fbpfcp-watermark.image)

`html`ç»“æ„ï¼š

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cac5a8527f4b4dec87128811612655f0~tplv-k3u1fbpfcp-watermark.image)

å¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯åºåˆ—åŒ–çš„æ•°æ®è¿˜æ˜¯`DOM`ç»“æ„éƒ½å·²ç»ç®€æ´äº†å¾ˆå¤šã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ–‡æ¡£ç»“æ„å¾ˆå¤æ‚æˆ–è€…å¤šæ¬¡é‡å¤åˆ’çº¿æœ€ç»ˆäº§ç”Ÿçš„èŠ‚ç‚¹å’Œæ•°æ®è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ã€‚

# æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†ä¸€ä¸ªå®ç°`web`æ–‡æœ¬åˆ’çº¿åŠŸèƒ½çš„æç®€å®ç°ï¼Œæœ€åˆçš„æƒ³æ³•æ˜¯é€šè¿‡åˆ‡å‰²æˆå•ä¸ªå­—ç¬¦æ¥è¿›è¡ŒåŒ…è£¹ï¼Œè¿™æ ·çš„ä¼˜ç‚¹æ˜¯ååˆ†ç®€å•ï¼Œç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§ç”Ÿçš„åºåˆ—å·æ•°æ®å¾ˆå¤§ã€ä¿®æ”¹çš„`DOM`ç»“æ„å¾ˆå¤æ‚ï¼Œåœ¨æ–‡ç« åŠ`demo`çš„å†™ä½œè¿‡ç¨‹ä¸­ç»è¿‡å®è·µï¼Œå‘ç°ç›´æ¥åŒ…è£¹æ•´å—æ–‡å­—ä¹Ÿå¹¶ä¸ä¼šå¸¦æ¥å¤ªå¤šé—®é¢˜ï¼Œä½†æ˜¯å´èƒ½å‡å°‘å’Œä¼˜åŒ–å¾ˆå¤šè¦å­˜å‚¨çš„æ•°æ®å’Œ`DOM`ç»“æ„ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™ï¼Œæƒ³å½“ç„¶æ˜¯ä¸å¯¹çš„ï¼Œæœ€åæƒ³è¯´ï¼Œæ•°æ®ç»“æ„å’Œç®—æ³•çœŸçš„å¾ˆé‡è¦ğŸ˜­ã€‚

ç¤ºä¾‹ä»£ç åœ¨ï¼š[https://github.com/wanglin2/textUnderline](https://github.com/wanglin2/textUnderline)ã€‚

å‚è€ƒæ–‡ç« ï¼š

1.[å¦‚ä½•ç”¨JSå®ç°â€œåˆ’è¯é«˜äº®â€çš„åœ¨çº¿ç¬”è®°åŠŸèƒ½ï¼Ÿ](https://juejin.cn/post/6844903827745832967)

2.[ã€Œåˆ’çº¿é«˜äº®ã€å’Œã€Œæ’å…¥ç¬”è®°ã€â€”â€” ä¸æ­¢æ˜¯å‰ç«¯çŸ¥è¯†ç‚¹](https://juejin.cn/post/6870058781527506952)
